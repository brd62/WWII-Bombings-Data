<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
  <meta charset="utf-8">
  <title>Project 2</title>
  <style media="screen">
    .country {
      fill: rgba(8, 81, 156, 0.6);
      stroke: rgba(8, 81, 156, 0.2);
      stroke-width: 1px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="europeMap">
      <svg width="600" height="600" id="map"></svg>
      <svg width="600" height="600" id="data"></svg>

    </div>
  </div>


  <script type="text/javascript">
    let svg = d3.select("#map");
    let svg2 = d3.select("#data");

    let width = svg.attr("width");
    let height = svg.attr("height");

    let width2 = svg2.attr("width");
    let height2 = svg2.attr("height");

    let margin = {
      top: 10,
      right: 10,
      bottom: 10,
      left: 10
    };

    let mapWidth = width - margin.left - margin.right;
    let mapHeight = height - margin.top - margin.bottom;
    let mapGroup = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    let dataGroup = svg2.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    const awaitData = async () => {

      const europe = await d3.json("europe.json");
      const ww1 = await d3.json("ww1_data.json");
      let ww2 = await d3.csv("ww2_data.csv", d3.autoType);


      let bogusValues = ["", null, "UNKNOWN OR NOT INDICATED", "UNIDENTIFIED"];

      ww2 = ww2.filter(d => !bogusValues.includes(d["COUNTRY_FLYING_MISSION"]) && !bogusValues.includes(d["TGT_COUNTRY"]) && !bogusValues.includes(d["TGT_LOCATION"]));
      var data1 = ww1;
      let countries = europe;

      let projection = d3.geoMercator().fitSize([mapWidth, mapHeight], countries);
      let path = d3.geoPath().projection(projection);

      ww1.forEach(d => {
        d["position"] = projection([d.LONGITUDE, d.LATITUDE]);
        d["year"] = Number(d.MSNDATE.substring(d.MSNDATE.length - 4));
      })

      ww2.forEach(d => {
        d["position"] = projection([d.LONGITUDE, d.LATITUDE])
        d["year"] = Number(d.MSNDATE.substring(d.MSNDATE.length - 4));
      })

      let minYearWW1 = d3.min(ww1, d => d["year"]);
      let minYearWW2 = d3.min(ww2, d => d["year"]);
      let maxYearWW1 = d3.max(ww1, d => d["year"]);
      let maxYearWW2 = d3.max(ww2, d => d["year"]);

      mapGroup.selectAll("path").data(europe.features)
        .enter()
        .append("path")
        .attr("class", "country")
        .attr("id", d => d.properties.country)
        .attr("d", path)

      let zoom = d3.zoom()
        .scaleExtent([1, 10])
        .translateExtent([
          [-50, -50],
          [mapWidth + 50, mapHeight + 50]
        ])
        .on("zoom", zoomed)

      svg.call(zoom)
      svg.call(zoom.transform, d3.zoomIdentity);
      var transform

      function zoomed() {
        transform = d3.event.transform;
        mapGroup.attr("transform", transform.toString());

        mapGroup.selectAll("circle")
          .attr("r", 1 / Math.sqrt(transform.k))

      }

      var ww1id;
      var circle;
      var circle2

      circle = mapGroup.selectAll(".ww1circle").data(ww1)
        .enter()
        .append("circle")
        .attr("r", 1)
        .attr("opacity", 0.8)
        .attr("class", "ww1circle")
        .attr("cx", d => d.position[0])
        .attr("cy", d => d.position[1])
        .attr("year", d => d.year)
        .attr("fill", "orange");

      circle.on("mouseover", function(data) {
        d3.select(this)
          .attr("fill", "black")
          .attr("r", 1.5);
        dataGroup.append("text")
          .attr("x", width / 4)
          .attr("y", height / 4)
          .attr("class", "wow")
          .text(d => data['TGTLOCATION'] + ", " + data['TGTCOUNTRY'] + ", " + data["year"]);


      })
      circle.on("mouseout", function() {
        d3.select(this)
          .attr("fill", "orange")
          .attr("r", 1 / Math.sqrt(transform.k));
        d3.select(".wow").remove()

      })

      // comment out below for quicker load
      circle2 = mapGroup.selectAll(".ww2circle").data(ww2)
        .enter()
        .append("circle")
        .attr("r", 1)
        .attr("opacity", 0.8)
        .attr("class", ".ww2circle")
        .attr("cx", d => d.position[0])
        .attr("cy", d => d.position[1])
        .attr("year", d => d.year)
        .attr("fill", "purple");

      circle2.on("mouseover", function(data) {
        d3.select(this)
          .attr("fill", "black")
          .attr("r", 1.5);
        dataGroup.append("text")
          .attr("x", width2 / 2)
          .attr("y", height2 / 4)
          .attr("id", "wow")
          .text(d => data['TGT_LOCATION'] + ", " + data["TGT_COUNTRY"] + ", " + data["year"]);

      })
      circle2.on("mouseout", function() {
        d3.select(this)
          .attr("fill", "purple")
          .attr("r", 1 / Math.sqrt(transform.k));
        d3.select("#wow").remove()

      })


    }


    awaitData();
  </script>
</body>

</html>
